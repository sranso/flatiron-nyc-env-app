<h1>Filter Results</h1>
<form action="/filter" method="POST">

  <h3>Data Set</h3>
  <% @datasets.each do |dataset| %>
    <label for="data-set"><%= dataset %></label>
    <input type="checkbox" class="data-set-class" name="datasets[<%= dataset %>]">
  <% end %>

  <button type="submit" value="Filter">Filter Results</button>
</form>

<div id="panel">
  <input id="address" type="textbox" value="Sydney, NSW">
  <input type="button" value="Geocode" onclick="codeAddress()">
</div>
<div id="map-canvas"></div>

<script type="text/javascript">
  //initialize map
  var geocoder;
  var map;
  var markers = [];

  function initialize() {
    geocoder = new google.maps.Geocoder();

    var mapOptions = {
      zoom: 10,
      center: new google.maps.LatLng(40.6700, -73.9400)
    };

    // create that map
    map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
  
  }

  // find position on map by addresss
  function codeAddress(address) {
    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        var marker = new google.maps.Marker({
            map: map,
            position: results[0].geometry.location
        });
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }
  // Add a marker to the map and push to the array.
  function addMarker(location) {
    var marker = new google.maps.Marker({
      position: location,
      map: map
    });
    markers.push(marker);
  }

  // Sets the map on all markers in the array.
  function setAllMap(map) {
    for (var i = 0; i < markers.length; i++) {
      markers[i].setMap(map);
    }
  }

  // Removes the markers from the map, but keeps them in the array.
  function clearMarkers() {
    setAllMap(null);
  }

  // load the map
  google.maps.event.addDomListener(window, 'load', initialize);

  // click event, when a checkbox is clicked
  $('.data-set-class').click(function() {
    var $this = $(this);
    // get JSON file name
    var dataName = $this.prev("label").text();
    var fileName = "data/" + dataName.replace(/ /g, "-") + ".json";

    if ($this.hasClass("selected")) {
      $this.removeClass("selected");
      clearMarkers();
    } else {
      $this.addClass("selected");
      // load the dataset
      $.getJSON(fileName, function(response) {
        // debugger
        // the following works for nyc-cool-roofs
        for (var i = 0; i < response.data.length; i++) {
          var newLatLon = new google.maps.LatLng(response.data[i][13][1], response.data[i][13][2])
          addMarker(newLatLon);
        };
        // the following works for nyc-green-thumb
        // response.data[0][13]; gives address
        for (var i = 0; i < response.data.length; i++) {
          var newLatLon = new google.maps.LatLng(response.data[i][13][1], response.data[i][13][2])
          addMarker(newLatLon);
        };
      });
    };
    
    
  });

</script>
